# Эксперимент 19: SGD → GD → SGD с логированием (Similar MNIST)

## Описание
Трехэтапный эксперимент для изучения поведения SGD в настоящем минимуме на похожих данных MNIST:

1. **SGD обучение** (10 эпох) - обучение до хорошей точки, логирование среднего лосса по эпохе
2. **GD к минимуму** (10 эпох) - доползание до настоящего минимума, логирование лосса по эпохе
3. **SGD с логированием** (16 эпох ≈ 1000 батчей) - гессианы по батчам, лосс усредненный по эпохе

## Параметры
- **Learning rates**: 0.1, 0.5 (1e-1, 5e-1)
- **Batch size**: 64
- **Модель**: FlexibleMLP (8 hidden, 1 layer, downsample=6)
- **Датасет**: Similar MNIST (scripts/data/mnist_similar_x.pt, scripts/data/mnist_similar_y.pt)

## Запуск

### Автоматический запуск всех экспериментов:
```bash
./run_exp19.sh
```

### Ручной запуск для конкретного lr:
```bash
python exp19_train.py --lr 0.1 --sgd-epochs 10 --gd-epochs 10 --sgd-log-epochs 16
python exp19_train.py --lr 0.5 --sgd-epochs 10 --gd-epochs 10 --sgd-log-epochs 16
```

### Запуск через runner:
```bash
python exp19_runner.py
```

## Структура результатов

Для каждого learning rate создаются файлы:
```
data/checkpoints/exp19/
├── model_lr0.1.pth              # Финальная модель
├── params_lr0.1.pkl             # Траектории параметров (этап 3)
├── hessians_lr0.1.pkl           # Гессианы (этап 3)
├── metadata_lr0.1.pkl           # Метаданные всех этапов
├── exp19_lr0.1.png              # График всех 3 этапов
├── model_lr0.5.pth              # То же для lr=0.5
├── params_lr0.5.pkl
├── hessians_lr0.5.pkl
├── metadata_lr0.5.pkl
└── exp19_lr0.5.png
```

## Анализ результатов

### Метаданные содержат:
- `stage_transitions`: точки переходов между этапами (в эпохах)
- `all_train_losses`: средние потери по эпохам всех 3 этапов
- `all_val_losses`: валидационные потери по эпохам
- `params_shape`: размерность траекторий параметров (по батчам этапа 3)
- `hessians_shape`: размерность гессианов (по батчам этапа 3)

### Графики показывают:
- Средние потери по эпохам с вертикальными линиями переходов
- Логарифмический масштаб потерь
- Валидационные метрики по эпохам
- Четкое разделение на 3 этапа

## Цель эксперимента
Изучить поведение SGD в настоящем минимуме после того, как GD довел модель до точного минимума на похожих данных MNIST. Логирование по эпохам позволяет:
- Проанализировать стохастический шум в минимуме (гессианы по батчам)
- Сравнить средние потери по эпохам между этапами
- Понять, как SGD ведет себя после точной оптимизации на похожих данных